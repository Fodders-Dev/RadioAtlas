# CODEX_RULES — TG Radio Mini App (AUTOPILOT, меньше слов — больше кода)

Ты — ведущий инженер проекта Telegram Mini App для интернет-радио.
Цель: собрать рабочий продукт максимально автономно. Пользователь делает только ревью (“норм/переделай”).

## AUTOPILOT
- Если пользователь не дал конкретной задачи — сам выбирай следующий логичный шаг и выполняй.
- Не останавливайся на каждом шагу, не “рассказывай план” словами — делай коммитоподобные изменения в файлах.
- Каждый шаг должен оставлять проект запускаемым.

## Формат ответа (строго)
Пиши только:

DONE: 1–3 строки что сделано.  
FILES: список изменённых/новых файлов.  
RUN: команды для запуска/проверки (если нужно).  
NEED: максимум 1 вопрос, только если реально заблокирован. Иначе NEED: -

Никаких эссе.

## Референсы (обязательны — открой и скопируй ключевые UX-паттерны)
- Radio++ applet (табы Find Station / My Stations / Preferences, поиск + таблица Name/URL):  
  https://cinnamon-spices.linuxmint.com/applets/view/297
- Radio Garden (глобус с точками + нижняя навигация Explore/Favorites/Browse/Search/Settings + мини-плеер):  
  https://radio.garden/
- Мобильная версия Radio Garden (идея и навигация):  
  https://play.google.com/store/apps/details?id=com.jonathanpuckey.radiogarden&hl=en

## Источник станций (по умолчанию)
- Используй Radio Browser API (много станций + geo + метаданные):  
  https://docs.radio-browser.info/
- В запросах указывай адекватный User-Agent (например `FodderRadio/0.1`).

## MVP (Definition of Done)
Собран monorepo TypeScript и работает end-to-end:

1) Telegram Bot:
- /start → кнопка “Открыть радио” (WebApp)
- deep link на открытие миниаппа
- (опционально) команда /share для шаринга станции

2) WebApp (Telegram Mini App):
- Экран Explore: “глобус/мир” с точками станций (как в Radio Garden).
  MVP допускает 2D-глобус-проекцию (orthographic) или лёгкую карту мира, но UX должен ощущаться как “путешествие по миру”.
- Нижняя навигация (как в Radio Garden): Explore / Favorites / Browse / Search / Settings.
- Мини-плеер всегда видим снизу:
  - Play/Pause, название станции, страна/город (если есть),
  - Favorite toggle,
  - громкость,
  - кнопка Share.
- Browse: континент → страна → список станций.
- Search: поиск по названию/тегам/стране/языку (быстро, с debounce).
- Favorites + Recently played (local storage).

3) Стриминг:
- HTML5 `<audio>` с устойчивостью:
  - авто-reconnect при ошибке,
  - таймауты,
  - отображение состояния (buffering/playing/error).
- HLS: подключать hls.js только если реально нужно (lazy import).
- “Фоновое прослушивание” — best-effort:
  - Media Session API где доступно,
  - кнопка “Открыть поток во внешнем плеере/браузере” как fallback.

4) Производительность:
- Кэш ответов каталога (memory + local cache).
- Lazy loading списка/точек.
- Минимум тяжёлых зависимостей.

5) Документация:
- README.md: запуск локально, переменные окружения, деплой (минимально).
- SPEC.md: UX/экраны/плеер/ограничения Telegram.
- PLAN.md: задачи и `Next:` всегда заполнен.
- RUNBOOK.md: команды, отладка аудио/стримов.

## Важное про HTTPS/мобилку (решай сам, но не молчи)
- Многие радиопотоки бывают `http://` → в WebView/HTTPS это может блокироваться (mixed content).
- Для MVP:
  - предпочитай `https://` потоки (фильтруй),
  - если этого мало — добавь опциональный /apps/api прокси.
- НЕ делай “аудио-проксирование всего мира” по умолчанию (дорого по трафику).
  Прокси для аудио — опционально и документировано (риски/стоимость).

## Стек (выбирай сам, но приоритет: простота и скорость разработки)
- WebApp: React + Vite + TypeScript.
- Bot: grammY или Telegraf (выбери сам).
- Monorepo: pnpm workspaces (или npm, если проще).
- Карта/глобус: лёгкая реализация (canvas + d3-geo или аналог). 3D three.js — только если не убьёт производительность.

## Минимум вопросов пользователю
Спрашивай только:
- название приложения (можешь поставить дефолт),
- когда нужен bot token и публичный URL для WebApp,
- ревью финального UI.
